{% extends 'core/base.html' %}

{% block title %}Admin Dashboard - Online Kawadiwala{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="text-success mb-1">
            <i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard
          </h2>
          <p class="lead text-muted mb-0">System Overview & Management</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-success" onclick="refreshData()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
          </button>
          <a href="/admin/" class="btn btn-success" target="_blank">
            <i class="fas fa-tools me-1"></i>Django Admin
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Metrics Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-primary text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-users fa-2x me-2"></i>
            <h3 class="mb-0">{{ user_stats.total|default:0 }}</h3>
          </div>
          <p class="mb-0 fw-semibold">Total Users</p>
          <small class="opacity-75">All registered users</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-success text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-user fa-2x me-2"></i>
            <h3 class="mb-0">{{ user_stats.customers|default:0 }}</h3>
          </div>
          <p class="mb-0 fw-semibold">Customers</p>
          <small class="opacity-75">Waste sellers</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-info text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-truck fa-2x me-2"></i>
            <h3 class="mb-0">{{ user_stats.collectors|default:0 }}</h3>
          </div>
          <p class="mb-0 fw-semibold">Collectors</p>
          <small class="opacity-75">Waste collectors</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-warning text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-clipboard-list fa-2x me-2"></i>
            <h3 class="mb-0">{{ pickup_stats.total|default:0 }}</h3>
          </div>
          <p class="mb-0 fw-semibold">Total Pickups</p>
          <small class="opacity-75">All pickup requests</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Pickup Statistics -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-secondary text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-check-circle fa-2x me-2"></i>
            <h4 class="mb-0">{{ pickup_stats.completed|default:0 }}</h4>
          </div>
          <p class="mb-0 fw-semibold">Completed</p>
          <small class="opacity-75">Successfully finished</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-danger text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-clock fa-2x me-2"></i>
            <h4 class="mb-0">{{ pickup_stats.pending|default:0 }}</h4>
          </div>
          <p class="mb-0 fw-semibold">Pending</p>
          <small class="opacity-75">Awaiting assignment</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-dark text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-calendar-alt fa-2x me-2"></i>
            <h4 class="mb-0">{{ pickup_stats.this_month|default:0 }}</h4>
          </div>
          <p class="mb-0 fw-semibold">This Month</p>
          <small class="opacity-75">Current month requests</small>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stat-card bg-gradient-success text-white shadow-sm">
        <div class="card-body text-center">
          <div class="d-flex justify-content-center align-items-center mb-2">
            <i class="fas fa-weight-hanging fa-2x me-2"></i>
            <h4 class="mb-0">{{ total_transactions|floatformat:1|default:0 }}</h4>
          </div>
          <p class="mb-0 fw-semibold">Total Weight (kg)</p>
          <small class="opacity-75">Recycled materials</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Data Tables -->
  <div class="row mb-4">
    <!-- Recent Pickup Requests -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-list me-2"></i>Recent Pickup Requests
          </h6>
          <div class="d-flex gap-2">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-tasks me-1"></i>Bulk Actions
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="bulkAction('mark_completed')">
                  <i class="fas fa-check me-2"></i>Mark as Completed</a></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('mark_cancelled')">
                  <i class="fas fa-times me-2"></i>Cancel Selected</a></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('unassign')">
                  <i class="fas fa-user-times me-2"></i>Unassign Collector</a></li>
              </ul>
            </div>
            <small class="align-self-center">Last 15 requests</small>
          </div>
        </div>
        <div class="card-body p-0">
          {% if recent_pickups %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>
                      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Collector</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for pickup in recent_pickups %}
                  <tr>
                    <td>
                      <input type="checkbox" name="pickup_ids" value="{{ pickup.id }}" class="pickup-checkbox">
                    </td>
                    <td>
                      <strong>#{{ pickup.id }}</strong>
                    </td>
                    <td>
                      <small class="text-muted">{{ pickup.pickup_date|date:"M d" }}</small>
                    </td>
                    <td>
                      <strong>{{ pickup.customer.username }}</strong>
                      <br><small class="text-muted">{{ pickup.customer.email|truncatechars:20 }}</small>
                    </td>
                    <td>
                      {% if pickup.collector %}
                        <span class="badge bg-info">{{ pickup.collector.username }}</span>
                      {% else %}
                        <span class="badge bg-secondary">Unassigned</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="badge bg-light text-dark">{{ pickup.waste_category.name }}</span>
                      <br><small class="text-muted">Rs {{ pickup.estimated_price }}</small>
                    </td>
                    <td>
                      {% if pickup.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                      {% elif pickup.status == 'pending' %}
                        <span class="badge bg-warning">Pending</span>
                      {% elif pickup.status == 'assigned' %}
                        <span class="badge bg-info">Assigned</span>
                      {% elif pickup.status == 'in_progress' %}
                        <span class="badge bg-primary">In Progress</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ pickup.status|capfirst }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="openStatusModal({{ pickup.id }}, '{{ pickup.status }}', '{{ pickup.customer.username }}', '{{ pickup.waste_category.name }}')" 
                                title="Update Status">
                          <i class="fas fa-edit"></i>
                        </button>
                        {% if pickup.status == 'in_progress' %}
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="quickComplete({{ pickup.id }})" 
                                title="Quick Complete">
                          <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted">No recent pickup requests found.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Pending Transactions -->
    <div class="col-lg-4 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-money-bill-wave me-2"></i>Pending Transactions
          </h6>
          <small>Awaiting approval</small>
        </div>
        <div class="card-body p-0">
          {% if pending_transactions %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Amount</th>
                    <th>Collector</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for transaction in pending_transactions %}
                  <tr>
                    <td>
                      <strong>#{{ transaction.id }}</strong>
                      <br><small class="text-muted">{{ transaction.transaction_date|date:"M d" }}</small>
                    </td>
                    <td>
                      <strong>Rs {{ transaction.amount }}</strong>
                      <br><small class="text-success">Commission: Rs {{ transaction.collector_commission }}</small>
                    </td>
                    <td>
                      <strong>{{ transaction.collector.username }}</strong>
                      <br><small class="text-muted">Pickup #{{ transaction.pickup_request.id }}</small>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="approveTransaction({{ transaction.id }})" 
                                title="Approve">
                          <i class="fas fa-check"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="rejectTransaction({{ transaction.id }})" 
                                title="Reject">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
              <p class="text-muted">No pending transactions.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Waste Categories Management -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-recycle me-2"></i>Waste Categories Management
          </h6>
          <div>
            <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
              <i class="fas fa-plus me-1"></i>Add Category
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          {% if waste_categories %}
            <div class="table-responsive">
              <table class="table table-striped mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>Category Name</th>
                    <th>Rate per KG</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for cat in waste_categories %}
                  <tr>
                    <td>
                      <strong>{{ cat.name }}</strong>
                    </td>
                    <td>
                      <span class="fw-bold text-success">Rs. {{ cat.rate_per_kg }}</span>
                    </td>
                    <td>
                      <small class="text-muted">{{ cat.description|default:"No description"|truncatechars:40 }}</small>
                    </td>
                    <td>
                      {% if cat.is_active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-danger">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <small class="text-muted">{{ cat.created_at|date:"M d, Y" }}</small>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" title="Edit" 
                                onclick="editCategory({{ cat.id }}, '{{ cat.name }}', {{ cat.rate_per_kg }}, '{{ cat.description }}', {{ cat.is_active|yesno:'true,false' }})">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" title="Delete" 
                                onclick="deleteCategory({{ cat.id }}, '{{ cat.name }}')">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <p class="text-muted">No waste categories found.</p>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus me-1"></i>Add First Category
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- User Management Widget -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-users-cog me-2"></i>User Management
          </h6>
          <div>
            <a href="{% url 'manage_users' %}" class="btn btn-sm btn-outline-light">
              <i class="fas fa-external-link-alt me-1"></i>Full Management
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          {% if recent_users %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Quick Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in recent_users %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="avatar-sm me-2">
                          <i class="fas fa-user text-primary"></i>
                        </div>
                        <div>
                          <strong>{{ user.get_full_name|default:user.username }}</strong>
                          <br><small class="text-muted">{{ user.email|default:"No email"|truncatechars:25 }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      {% if user.role == 'admin' %}
                        <span class="badge bg-danger">
                          <i class="fas fa-user-shield me-1"></i>Admin
                        </span>
                      {% elif user.role == 'collector' %}
                        <span class="badge bg-info">
                          <i class="fas fa-truck me-1"></i>Collector
                        </span>
                      {% else %}
                        <span class="badge bg-success">
                          <i class="fas fa-user me-1"></i>Customer
                        </span>
                      {% endif %}
                    </td>
                    <td>
                      {% if user.is_active %}
                        <span class="badge bg-success">Active</span>
                      {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <small class="text-muted">{{ user.date_joined|date:"M d" }}</small>
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-info btn-sm" 
                                onclick="viewUserQuickDetails('{{ user.username }}', '{{ user.email }}', '{{ user.role }}')" 
                                title="View Details">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-3">
              <i class="fas fa-users fa-2x text-muted mb-2"></i>
              <p class="text-muted mb-0">No recent users found.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row">
    <div class="col-12">
      <div class="card border-0 bg-light">
        <div class="card-body text-center py-4">
          <h6 class="text-muted mb-3">Quick Actions</h6>
          <div class="d-flex justify-content-center flex-wrap gap-2">
            <a href="{% url 'manage_users' %}" class="btn btn-outline-primary">
              <i class="fas fa-users-cog me-1"></i>User Management
            </a>
            <a href="/admin/core/pickuprequest/" class="btn btn-outline-success" target="_blank">
              <i class="fas fa-clipboard-list me-1"></i>Manage Pickups
            </a>
            <a href="/admin/core/wastecategory/" class="btn btn-outline-warning" target="_blank">
              <i class="fas fa-recycle me-1"></i>Manage Categories
            </a>
            <a href="/admin/core/transaction/" class="btn btn-outline-info" target="_blank">
              <i class="fas fa-money-bill-wave me-1"></i>View Transactions
            </a>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exportModal">
              <i class="fas fa-download me-1"></i>Export Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Update Pickup Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="updateStatusModalLabel">
          <i class="fas fa-edit me-2"></i>Update Pickup Status
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="updateStatusForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"><strong>Pickup Details:</strong></label>
            <div id="pickupDetails" class="p-2 bg-light rounded"></div>
          </div>
          <div class="mb-3">
            <label for="statusSelect" class="form-label">New Status</label>
            <select class="form-select" id="statusSelect" name="status" required>
              {% for status_code, status_display in status_choices %}
                <option value="{{ status_code }}">{{ status_display }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="weightSection" style="display: none;">
            <label for="actualWeight" class="form-label">Actual Weight (kg)</label>
            <input type="number" class="form-control" id="actualWeight" name="actual_weight_kg" step="0.01" min="0.1">
            <small class="form-text text-muted">Required when marking as completed</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Update Status
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Export Data Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="exportModalLabel">
          <i class="fas fa-download me-2"></i>Export Pickup Data
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="exportForm" method="get" action="{% url 'export_data_pdf' %}">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="startDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" name="start_date">
                <small class="form-text text-muted">Leave empty for no start date filter</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="endDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="endDate" name="end_date">
                <small class="form-text text-muted">Leave empty for no end date filter</small>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="statusFilter" class="form-label">Status Filter</label>
                <select class="form-select" id="statusFilter" name="status">
                  <option value="all">All Statuses</option>
                  {% for status_code, status_display in status_choices %}
                    <option value="{{ status_code }}">{{ status_display }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Price Range (Rs)</label>
                <div class="row">
                  <div class="col-6">
                    <input type="number" class="form-control" id="minPrice" name="min_price" placeholder="Min Price" step="0.01" min="0">
                  </div>
                  <div class="col-6">
                    <input type="number" class="form-control" id="maxPrice" name="max_price" placeholder="Max Price" step="0.01" min="0">
                  </div>
                </div>
                <small class="form-text text-muted">Leave empty for no price filter</small>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Export Information:</strong>
            <ul class="mb-0 mt-2">
              <li>Data will be exported as a formatted PDF file</li>
              <li>Includes: ID, Date, Customer, Collector, Category, Weight (kg), Actual Weight (kg), Price (Rs), Status</li>
              <li>Filters are optional - leave empty to export all data</li>
              <li>Large exports may take a few moments to generate</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-file-pdf me-1"></i>Generate PDF Export
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addCategoryModalLabel">
          <i class="fas fa-plus me-2"></i>Add New Waste Category
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addCategoryForm">
          <div class="mb-3">
            <label for="categoryName" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="categoryName" name="categoryName" placeholder="e.g., Paper, Plastic, Metal" required>
          </div>
          <div class="mb-3">
            <label for="categoryRate" class="form-label">Rate per KG (Rs.)</label>
            <input type="number" class="form-control" id="categoryRate" name="categoryRate" step="0.01" min="0" placeholder="0.00" required>
          </div>
          <div class="mb-3">
            <label for="categoryDescription" class="form-label">Description</label>
            <textarea class="form-control" id="categoryDescription" name="categoryDescription" rows="3" placeholder="Brief description of this waste category"></textarea>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="categoryActive" name="categoryActive" checked>
            <label class="form-check-label" for="categoryActive">
              Active (available for pickup requests)
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addCategory()">
          <i class="fas fa-plus me-1"></i>Add Category
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function refreshData() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    button.disabled = true;
    
    // Simulate refresh (in real app, you'd reload the page or fetch new data)
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function addCategory() {
    const form = document.getElementById('addCategoryForm');
    const modal = document.getElementById('addCategoryModal');
    const categoryId = modal.getAttribute('data-category-id');
    
    // Determine if this is an edit or add operation
    const isEdit = categoryId && categoryId !== '';
    const url = isEdit ? `/admin-manage/edit-category/${categoryId}/` : '/admin-manage/add-category/';
    
    // Create form data
    const formData = new FormData(form);
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Submit form
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (response.ok) {
            // Reload page to show updated data
            window.location.reload();
        } else {
            showAlert('Error saving category. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving category. Please try again.', 'error');
    });
    
    // Close modal
    bootstrap.Modal.getInstance(modal).hide();
    
    // Reset modal for next use
    modal.removeAttribute('data-category-id');
    document.getElementById('addCategoryModalLabel').innerHTML = '<i class="fas fa-plus me-2"></i>Add New Waste Category';
    document.querySelector('#addCategoryModal .btn-success').innerHTML = '<i class="fas fa-save me-1"></i>Add Category';
    form.reset();
}

// Export functionality is now handled by the modal form

// Waste Category Management Functions
function editCategory(id, name, rate, description, isActive) {
    // Populate the form with existing data
    document.getElementById('categoryName').value = name;
    document.getElementById('categoryRate').value = rate;
    document.getElementById('categoryDescription').value = description;
    document.getElementById('categoryActive').checked = isActive;
    
    // Change modal title and button text
    document.getElementById('addCategoryModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Waste Category';
    document.querySelector('#addCategoryModal .btn-success').innerHTML = '<i class="fas fa-save me-1"></i>Update Category';
    
    // Store category ID for update
    document.getElementById('addCategoryModal').setAttribute('data-category-id', id);
    
    // Show modal
    new bootstrap.Modal(document.getElementById('addCategoryModal')).show();
}

function deleteCategory(id, name) {
    if (confirm(`Are you sure you want to delete the category "${name}"? This action cannot be undone.`)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin-manage/delete-category/${id}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Admin pickup management functions
let currentPickupId = null;

function openStatusModal(pickupId, currentStatus, customerName, categoryName) {
    currentPickupId = pickupId;
    
    // Update pickup details
    document.getElementById('pickupDetails').innerHTML = `
        <strong>Pickup ID:</strong> #${pickupId}<br>
        <strong>Customer:</strong> ${customerName}<br>
        <strong>Category:</strong> ${categoryName}<br>
        <strong>Current Status:</strong> <span class="badge bg-secondary">${currentStatus}</span>
    `;
    
    // Set current status in select
    document.getElementById('statusSelect').value = currentStatus;
    
    // Show/hide weight section based on status
    toggleWeightSection();
    
    // Show modal
    new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
}

function toggleWeightSection() {
    const statusSelect = document.getElementById('statusSelect');
    const weightSection = document.getElementById('weightSection');
    
    if (statusSelect.value === 'completed') {
        weightSection.style.display = 'block';
        document.getElementById('actualWeight').required = true;
    } else {
        weightSection.style.display = 'none';
        document.getElementById('actualWeight').required = false;
    }
}

function quickComplete(pickupId) {
    if (confirm('Mark this pickup as completed? You will need to enter the actual weight.')) {
        openStatusModal(pickupId, 'completed', '', '');
        document.getElementById('statusSelect').value = 'completed';
        toggleWeightSection();
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.pickup-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function bulkAction(action) {
    const selectedPickups = document.querySelectorAll('.pickup-checkbox:checked');
    
    if (selectedPickups.length === 0) {
        showAlert('Please select at least one pickup.', 'error');
        return;
    }
    
    const actionText = action === 'mark_completed' ? 'mark as completed' :
                      action === 'mark_cancelled' ? 'cancel' : 'unassign collector from';
    
    if (confirm(`Are you sure you want to ${actionText} ${selectedPickups.length} pickup(s)?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "admin_bulk_update_pickups" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Add action
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'bulk_action';
        actionInput.value = action;
        form.appendChild(actionInput);
        
        // Add selected pickup IDs
        selectedPickups.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'pickup_ids';
            input.value = checkbox.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

function approveTransaction(transactionId) {
    if (confirm('Approve this transaction and mark as paid?')) {
        submitTransactionAction(transactionId, 'approve');
    }
}

function rejectTransaction(transactionId) {
    if (confirm('Reject this transaction?')) {
        submitTransactionAction(transactionId, 'reject');
    }
}

function submitTransactionAction(transactionId, action) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/admin-manage/approve-transaction/${transactionId}/`;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Add action
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = action;
    form.appendChild(actionInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Handle status form submission
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('statusSelect');
    if (statusSelect) {
        statusSelect.addEventListener('change', toggleWeightSection);
    }
    
    const updateForm = document.getElementById('updateStatusForm');
    if (updateForm) {
        updateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentPickupId) {
                this.action = `/admin-manage/update-pickup-status/${currentPickupId}/`;
                this.submit();
            }
        });
    }
});

function showAlert(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const alertHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                               type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

// Quick view user details function
function viewUserQuickDetails(username, email, role) {
    const roleDisplay = role === 'admin' ? 'Administrator' : 
                       role === 'collector' ? 'Collector' : 'Customer';
    
    alert(`User Details:\n\nUsername: ${username}\nEmail: ${email || 'Not provided'}\nRole: ${roleDisplay}\n\nFor full management options, visit the User Management page.`);
}

</script>

<style>
/* Custom styles for admin dashboard */
.stat-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 15px;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745, #1e7e34);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8, #117a8b);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107, #d39e00);
}

.bg-gradient-danger {
    background: linear-gradient(135deg, #dc3545, #a71d2a);
}

.bg-gradient-secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
}

.bg-gradient-dark {
    background: linear-gradient(135deg, #343a40, #1d2124);
}

.card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
    border: none;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0 15px;
    }
    
    .stat-card h3, .stat-card h4 {
        font-size: 1.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
}

/* Animation for page load */
.stat-card {
    animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Avatar styling for user management widget */
.avatar-sm {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: linear-gradient(45deg, #007bff, #0056b3);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}
</style>
{% endblock %}
